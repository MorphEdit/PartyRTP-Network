plugins {
    id 'java'
    id 'com.gradleup.shadow' version '8.3.5'
}

group = 'net.morphedit.partyrtp'
version = '1.0.0-NETWORK'

repositories {
    mavenCentral()
    maven {
        name = 'papermc'
        url = 'https://repo.papermc.io/repository/maven-public/'
    }
    maven {
        name = 'velocity'
        url = 'https://repo.velocitypowered.com/snapshots/'
    }
}

dependencies {
    implementation project(':partyrtp-common')
    implementation 'com.h2database:h2:1.4.200'  // เปลี่ยนเป็น 1.4.200
    implementation 'com.google.code.gson:gson:2.10.1'
    implementation 'org.yaml:snakeyaml:2.2'

    compileOnly 'com.velocitypowered:velocity-api:3.4.0-SNAPSHOT'
    annotationProcessor 'com.velocitypowered:velocity-api:3.4.0-SNAPSHOT'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

shadowJar {
    configurations = [project.configurations.runtimeClasspath]

    mergeServiceFiles()

    // !!! สำคัญ: ไม่ต้อง relocate H2 เพราะจะทำให้ internal references พัง
    // relocate เฉพาะ library ที่อาจ conflict กับ Velocity เท่านั้น
    relocate 'com.google.gson', 'net.morphedit.partyrtp.libs.gson'
    relocate 'org.yaml.snakeyaml', 'net.morphedit.partyrtp.libs.snakeyaml'

    // ไม่ relocate H2!
    // relocate 'org.h2', 'net.morphedit.partyrtp.libs.h2'

    archiveClassifier = ''
    archiveBaseName = 'PartyRTP-Velocity'
    archiveVersion = '1.0.0-NETWORK'

    manifest {
        attributes(
                'Multi-Release': 'true'
        )
    }
}

build {
    dependsOn shadowJar
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}